<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة متجر ريفان | نظام ذكي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f0f2f5; padding: 20px; display: none; }
        .admin-wrap { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid #8b0000; }
        h1 { color: #8b0000; text-align: center; margin-bottom: 20px; font-size: 24px; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Cairo'; outline: none; width: 100%; }
        .btn-save { background: #8b0000; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .product-list { margin-top: 30px; border-top: 2px solid #f4f4f4; padding-top: 20px; }
        .item { display: flex; justify-content: space-between; align-items: center; background: #fafafa; padding: 10px; margin-bottom: 8px; border-radius: 12px; border: 1px solid #eee; }
        .btn-del { background: #ff4d4d; color: white; border: none; padding: 5px 12px; border-radius: 8px; cursor: pointer; }
        @media (max-width: 600px) { .input-group { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="admin-wrap">
    <h1>لوحة تحكم ريفان ⚙️</h1>
    
    <div class="input-group">
        <input type="text" id="p-name" placeholder="اسم المنتج">
        <input type="number" id="p-price" step="0.001" placeholder="السعر (ر.ع)">
        <input type="text" id="p-img" placeholder="اسم الصورة (مثال: oil.jpg)">
        <select id="p-badge">
            <option value="">بدون وسم</option>
            <option value="جديد">وسم: جديد</option>
            <option value="عرض خاص">وسم: عرض خاص</option>
            <option value="الأكثر مبيعاً">الأكثر مبيعاً</option>
        </select>
    </div>
    <button class="btn-save" id="save-btn" onclick="saveProduct()">إضافة وتحديث المتجر الآن</button>

    <div class="product-list">
        <h3>المخزون الحالي:</h3>
        <div id="list">جاري التحميل من GitHub...</div>
    </div>
</div>

<script>
    const masterPass = "2024";
    const userPass = prompt("كلمة مرور الإدارة:");

    if (userPass === masterPass) {
        document.body.style.display = "block";
    } else {
        alert("خطأ!");
        window.location.href = "index.html";
    }

    // إعدادات GitHub (تأكدي أن الـ Token صحيح ومستودع souk موجود)
    const partA = "ghp_"; 
    const partB = "BEJ0TzUJEYJj2RNxvHEG"; 
    const partC = "NpmFL9RPOp3mkmYm"; 
    const TOKEN = partA + partB + partC;
    const OWNER = "faissaltunisia";
    const REPO = "souk";

    let currentProducts = [];
    let currentSha = null;

    async function loadData() {
        try {
            const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/products.json`, {
                headers: { "Authorization": `token ${TOKEN}` }
            });
            if(res.status === 404) {
                document.getElementById('list').innerText = "المتجر فارغ، أضيفي أول منتج سيتم إنشاء الملف تلقائياً.";
                return null;
            }
            const data = await res.json();
            currentSha = data.sha;
            currentProducts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            render();
            return data.sha;
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    function render() {
        if(currentProducts.length === 0) {
            document.getElementById('list').innerText = "لا توجد منتجات حالياً.";
            return;
        }
        document.getElementById('list').innerHTML = currentProducts.map((p, idx) => `
            <div class="item">
                <img src="${p.img}" width="40" height="40" style="border-radius:5px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/40'">
                <div style="flex-grow:1; margin-right:10px;">
                    <strong>${p.name}</strong><br>
                    <small>${p.price.toFixed(3)} ر.ع</small>
                </div>
                <button class="btn-del" onclick="deleteProduct(${idx})">حذف</button>
            </div>
        `).join('');
    }

    async function saveProduct() {
        const name = document.getElementById('p-name').value;
        const price = parseFloat(document.getElementById('p-price').value);
        const badge = document.getElementById('p-badge').value;
        let imgInput = document.getElementById('p-img').value;

        if (!name || isNaN(price) || !imgInput) return alert("أكملي البيانات أولاً");

        const finalImg = imgInput.startsWith('http') 
            ? imgInput 
            : `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/images/${imgInput}`;

        const btn = document.getElementById('save-btn');
        btn.innerText = "جاري التحديث..."; btn.disabled = true;

        currentProducts.push({ id: Date.now(), name, price, img: finalImg, badge });
        
        const success = await updateGitHub("تحديث المتجر");
        if(success) {
            alert("تم التحديث بنجاح!");
            location.reload();
        } else {
            alert("فشل التحديث! تأكدي من الـ Token أو اسم المستودع.");
            btn.innerText = "إضافة وتحديث المتجر الآن"; btn.disabled = false;
        }
    }

    async function deleteProduct(index) {
        if (confirm("حذف المنتج؟")) {
            currentProducts.splice(index, 1);
            await updateGitHub("حذف منتج");
            render();
        }
    }

    async function updateGitHub(msg) {
        try {
            const body = {
                message: msg,
                content: btoa(unescape(encodeURIComponent(JSON.stringify(currentProducts, null, 2))))
            };
            if (currentSha) body.sha = currentSha;

            const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/products.json`, {
                method: "PUT",
                headers: { 
                    "Authorization": `token ${TOKEN}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });
            return res.ok;
        } catch (e) {
            return false;
        }
    }

    loadData();
</script>
</body>
</html>
